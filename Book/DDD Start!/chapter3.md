## 애그리거트
### 애그리거트
- 생소한 개념이고 지금까지 내가 설계한게 잘못됐구나 라고 생각됐다. 잘못까지는 아닐테지만 도메인적으로 설계하지 못했구나 라고..
- 지금까지 나도 데이터베이스 중심적으로 개발했던 것 같다.
- 책을 읽으면서 많은 충격아닌 충격과 반성 등의 경험을 했다.
- 애그리거트는 애그리거트 루트를 중심으로 연관된 객체들은 밸류타입으로 설정한다.
- 한 애그리거트에 속한 객체들은 다른 애그리거트에 속하지 않는다. 독립된 객체 군 이며, 자기 자신 애그리거트를 관리할 뿐 다른 애그리거트를 관리하지 않는다.
- 필요하다면 테이블을 만들어야 겠지만 @entity 를 사용하는 것이 아니라 값 객체를 연결하는 과정에서 설정을 해준다.
```java
@ElementCollection
    @CollectionTable(name = "order_line", joinColumns = @JoinColumn(name = "order_number"))
    @OrderColumn(name = "line_idx")
    private List<OrderLine> orderLines;
```
### 애그리거트 루트와 역할
- 책에서는 주문 도메인에서 Order가 애그리거트 루트인데 애그리거트 루트와 밸류들은 하나의 라이프사이클로 이루어진다.
- 애그리거트 루트의 핵심은 일관성이 깨지지 않도록 하는 것이다.
- 하나의 트랜잭션에서 하나의 애그리거트만 처리되어야 한다. 부득이할 경우 응용영역에서 처리가 되어야 한다. (애그리거트 내의 객체에서 다른 애그리거트 객체를 참조하면 안된다는 말 같다.)
### 애그리거트와 리포지터리
- 리포지터리는 애그리거트 루트를 영속화 시켜야 한다.
- 다른 밸류객체나 루트가 아닌 객체들은 루트를 통해 조회된다.
### ID를 이용한 애그리거트 참조
- 일반적인 jpa 사용시 연관관계를 사용하여 객체를 참조하는데 다른 애그리거트를 참조하게 될경우 하나의 트랜잭션에서 수정되거나 하는 예상치 못한 일이 일어날 수 있다.
- 그렇기 때문에 연관관계 사용이 아닌 객체의 ID를 참조하는 걸로 객체를 설계 하는것이 좋다.
